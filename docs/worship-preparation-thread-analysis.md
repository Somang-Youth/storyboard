# 예배 준비 스레드 업무 흐름 분석 (somang-discord 구현 반영)

이 문서는 실제 디스코드 스레드 관찰 결과와 `somang-discord` 구현을 함께 기준으로 정리했다.

- 관찰 대상 스레드: `260222 예배 준비`, `260215 예배 준비`, `260208 예배 준비` 등
- 구현 근거 저장소: `Somang-Youth/somang-discord`

---

## 1) 실제 운영 흐름(사람이 하는 일)

주차 스레드는 대부분 아래 순서로 진행된다.

1. 봇이 주간 스레드 생성
2. 안내 메시지로 입력 포맷 제시 (`말씀`, `제목`, `찬양`)
3. 설교자/인도자/찬양인도자 선택
4. 실무 대화 진행 (멘션, 피드백, 첨부파일, 수정/재업로드)
5. 주보/PPT/업로드/스트리밍/인쇄 등 마감 체크

즉, 실제 스레드는 "구조화된 입력 + 자유 대화"가 공존한다.

---

## 2) `somang-discord`가 자동화하는 범위(코드 기준)

`somang-discord`는 스레드 전체 업무를 자동화하지 않고, **예배 핵심 데이터 동기화**를 자동화한다.

### A. 자동 생성/수집
- 주간 스레드 자동 생성: `app/api/cron/create-thread/route.ts`
- 초기 안내 메시지 생성: `lib/discord.ts` (`generateInitialMessage`)
- 드롭다운 3종 전송: 설교자/인도자/찬양인도자

### B. 메시지 파싱 대상
- `말씀`/`본문` → scripture
- `제목` → title
- `찬양` → songs(최대 4개)
- 구현: `lib/parser.ts`

### C. 보정/정규화
- 성경 표기 정규화(책 이름/장절 포맷): `lib/scripture-parser.ts`
- 제목 맞춤법 보정(네이버): `lib/spell-checker.ts`

### D. 저장/동기화
- Google Sheets `DB` 시트 반영: `lib/google-sheets.ts`
  - C: 설교자
  - D: 인도자
  - E: 찬양인도자
  - J: 제목
  - K: 말씀
  - L~O: 찬양1~4

### E. 처리 상태
- Redis에 현재 스레드/처리 메시지 ID 저장: `lib/kv.ts`
- 파싱 성공 메시지에 ✅ 리액션 추가

---

## 3) 자동화 "비대상" 영역 (현재 구현에서 안 하는 일)

아래는 스레드에서 자주 발생하지만, 현재 `somang-discord` 파이프라인이 직접 자동화하지 않는다.

- 광고 문안 작성/수정 상태 추적
- 나눔 질문 작성/확정 상태 추적
- 주보 시안 이미지 검수 라운드 관리
- PPT 제작/검수 완료 상태 추적
- 스트리밍 준비 완료 상태 추적
- 업로드/등록 완료 상태 추적
- 인쇄/악보/특송 요청-완료 상태 추적
- 멘션 기반 담당자 SLA/지연 관리

핵심적으로, **현재 구현은 업무관리 대시보드가 아니라 데이터 추출·시트 반영 자동화에 초점**이 있다.

---

## 4) 메시지 해석 규칙(정확한 동작)

### 파싱 규칙
- 줄 단위 `키: 값` 패턴만 해석
- `찬양` 값 분리 우선순위:
  1. 번호형 (`1. ... 2. ...`)
  2. `-`
  3. `/`
  4. `,`
  5. 단일값
- 최대 4곡만 사용

### 병합 규칙
- 크론 실행 시 새 메시지들을 순회하며 필드를 병합
- 동일 필드가 여러 번 등장하면 **마지막 값이 우선(last write wins)**

### 행 매핑 규칙
- 스레드의 `YYMMDD`를 `YYYY.MM.DD`로 변환해 `DB!B:B`에서 날짜 행 탐색
- 해당 날짜 행이 없으면 쓰기 실패

---

## 5) 운영 리스크/제약 (코드 기반)

1. `parse-comments`가 매분 동작하므로 호출량이 높음 (서버리스 비용/쿼터 고려 필요)
2. Google Sheet 날짜 행이 미리 준비되지 않으면 자동 반영 실패
3. 맞춤법 API는 비공식 의존(실패 시 원문 유지)
4. 첨부파일/리액션/멘션 자체를 업무 상태 모델로 구조화하진 않음
5. `send-week-dropdown` 엔드포인트는 운영 시 별도 보호 정책 점검 필요

---

## 6) 우리 대시보드 설계에 주는 시사점

실무적으로는 아래처럼 분리해서 보는 게 맞다.

1. **Data Sync Layer (`somang-discord` 강점)**
   - 말씀/제목/찬양/역할자 데이터를 안정적으로 추출·정규화·시트 반영
2. **Workflow Intelligence Layer (우리 앱에서 추가해야 할 영역)**
   - 광고/나눔질문/PPT/업로드/스트리밍/인쇄 등 "진행 상태"를 태스크 모델로 해석
   - 텍스트 + 멘션 + 리액션 + 첨부파일 기반 상태 추론

즉, 현재 봇을 기준으로 보면 "예배준비 업무 전체 자동화"의 기반은 일부만 완성된 상태이고,
업무 현황 대시보드는 별도 도메인 로직이 필요하다.

---

## 7) 결론

- 예배 준비 스레드는 이미 주간 업무 보드처럼 쓰이고 있다.
- `somang-discord`는 그중 **핵심 필드(말씀/제목/찬양/역할자) 자동 반영**을 매우 잘 수행한다.
- 하지만 **업무 현황 대시보드(진행/완료/이슈 추적)** 관점에서는 추가 모델링이 필요하다.

따라서 구현 핵심은 Discord API 자체보다 아래 4가지다.

1. 주간 스레드 식별
2. 업무 태스크 분류
3. 상태 신호 해석(텍스트/리액션/첨부/멘션)
4. 최신 상태 기준 대시보드화
